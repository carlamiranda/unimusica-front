<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Cadastro de Músicas</title>
    <style>
        .info {
            display: inline-block;
            width: 60%;
        }
        button {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Adicionar Música</h1>

        <form id="formMusica">
            <label>
                Nome da música:
                <input type="text" id="nome" placeholder="Nome da música" required />
            </label><br/>

            <label>
                Artista:
                <input type="text" id="artista" placeholder="Artista" required />
            </label><br/>

            <label>
                Ano de lançamento:
                <input type="number" id="anoLancamento" placeholder="Ano de lançamento" required />
            </label><br/>

            <label>
                Duração:
                <input type="number" id="duracao" placeholder="Duração" required min="0" />
            </label><br/>

            <button type="submit" id="submitBtn">Adicionar</button>
            <button type="button" id="cancelEditBtn" style="display:none;">Cancelar</button>
        </form>

        <h2>Lista de Músicas</h2>
        <ul id="listaMusicas"></ul>
    </div>

    <script>
        const urlBase = 'https://unimusica-production.up.railway.app/musicas';

        let musicaEditando = null;

        async function fetchMusicas() {
            try {
                const response = await fetch(urlBase);
                if (!response.ok) throw new Error('Erro ao buscar músicas');
                return await response.json();
            } catch (error) {
                console.error(error.message);
                return [];
            }
        }

        function mostrarMusicas(musicas) {
            const lista = document.getElementById('listaMusicas');
            lista.innerHTML = '';
            if (musicas.length === 0) {
                lista.textContent = 'Nenhuma música cadastrada.';
                return;
            }

            musicas.forEach(musica => {
                const li = document.createElement('li');

                const info = document.createElement('div');
                info.classList.add('info');
                info.textContent = `${musica.nome} - ${musica.artista} (${musica.anoLancamento}) [${musica.duracao} min]`;

                const botaoExcluir = document.createElement('button');
                botaoExcluir.textContent = 'Excluir';
                botaoExcluir.classList.add('excluir');
                botaoExcluir.onclick = () => excluirMusica(musica.id);

                const botaoEditar = document.createElement('button');
                botaoEditar.textContent = 'Editar';
                botaoEditar.classList.add('editar');
                botaoEditar.onclick = () => iniciarEdicao(musica);

                li.appendChild(info);
                li.appendChild(botaoEditar);
                li.appendChild(botaoExcluir);
                lista.appendChild(li);
            });
        }

        async function adicionarMusica(musica) {
            try {
                const response = await fetch(urlBase, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(musica)
                });
                if (!response.ok) throw new Error('Erro ao adicionar música');
                return await response.json();
            } catch (error) {
                console.error(error.message);
                return null;
            }
        }

        async function editarMusica(id, musicaAtualizada) {
            try {
                const response = await fetch(`${urlBase}/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(musicaAtualizada)
                });
                if (!response.ok) throw new Error('Erro ao editar música');
                return await response.json();
            } catch (error) {
                console.error(error.message);
                return null;
            }
        }

        async function excluirMusica(id) {
            const confirmar = confirm('Tem certeza que deseja excluir essa música?');
            if (!confirmar) return;

            try {
                const response = await fetch(`${urlBase}/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    alert('Música excluída!');
                    carregarMusicas();
                } else {
                    alert('Erro ao excluir música');
                }
            } catch (error) {
                console.error(error.message);
            }
        }

        function iniciarEdicao(musica) {
            musicaEditando = musica;
            document.getElementById('nome').value = musica.nome;
            document.getElementById('artista').value = musica.artista;
            document.getElementById('anoLancamento').value = musica.anoLancamento;
            document.getElementById('duracao').value = musica.duracao;

            document.getElementById('submitBtn').textContent = 'Salvar alteração';
            document.getElementById('cancelEditBtn').style.display = 'inline-block';
        }

        function cancelarEdicao() {
            musicaEditando = null;
            document.getElementById('formMusica').reset();
            document.getElementById('submitBtn').textContent = 'Adicionar';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        async function carregarMusicas() {
            const musicas = await fetchMusicas();
            mostrarMusicas(musicas);
        }

        document.getElementById('formMusica').addEventListener('submit', async (e) => {
            e.preventDefault();

            const novaMusica = {
                nome: document.getElementById('nome').value.trim(),
                artista: document.getElementById('artista').value.trim(),
                anoLancamento: parseInt(document.getElementById('anoLancamento').value),
                duracao: parseInt(document.getElementById('duracao').value)
            };

            if (musicaEditando) {
                const resultado = await editarMusica(musicaEditando.id, novaMusica);
                if (resultado) {
                    alert('Música atualizada com sucesso!');
                    cancelarEdicao();
                    carregarMusicas();
                } else {
                    alert('Falha ao atualizar música');
                }
            } else {
                const resultado = await adicionarMusica(novaMusica);
                if (resultado) {
                    alert('Música adicionada com sucesso!');
                    e.target.reset();
                    carregarMusicas();
                } else {
                    alert('Falha ao adicionar música');
                }
            }
        });

        document.getElementById('cancelEditBtn').addEventListener('click', cancelarEdicao);

        carregarMusicas();
    </script>
</body>
</html>
